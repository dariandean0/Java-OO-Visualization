<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Java OO Visualizer</title>
        <!--Load bootstrap 5 CSS stylesheet-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/darcula.min.css">

        <style>
            .CodeMirror{
                width: 100%;
                height: 100%;
            }
            .page { display: none; }
            .pactive { display: block; }
        </style>
    </head>
    <body>
        <!-- Navbar -->
        <nav class="navbar" style="background-color: #0d1a2d;" data-bs-theme="dark">
            <div class="container-fluid">
                <a class="navbar-brand me-4"><strong>Java OO Visualizer</strong></a>
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <form>
                        <button id="VisualizerB" type="button" onclick="goTo('Visualizer')" class="btn btn-primary me-2 pagebutton">Main Visualizer</button>
                        <button id="CreatorB" type="button" onclick="goTo('Creator')" class="btn btn-outline-primary me-2 pagebutton">Diagram Creator</button>
                        <button id="ComparerB" type="button" onclick="goTo('Comparer')" class="btn btn-outline-primary pagebutton">Diagram Comparer</button>
                    </form>
                </ul>
            </div>
        </nav>
        <!--Pages-->
        <script>
            function goTo(page){
                document.querySelectorAll('.page').forEach(p => p.classList.remove('pactive'));
                document.getElementById(page).classList.add('pactive');

                document.querySelectorAll('.pagebutton').forEach(pb => {
                    pb.classList.remove('btn-primary', 'btn-outline-primary');
                    if (pb.id !== page + "B") {
                        pb.classList.add('btn-outline-primary');
                    } else {
                        pb.classList.add('btn-primary');
                    }
                });
            }
        </script>

        <!--Import WASM-->
        <script type="module">
            import Module from '../wasm/backend.js';
            import * as Viz from 'https://cdn.jsdelivr.net/npm/@viz-js/viz@3.20.0/+esm'

            (async () => {
                const mod = await Module();

                const wasmExecFlowGen = mod.cwrap(
                    'wasm_execution_flow_gen',
                    'string',
                    ['string']
                );

                const wasmNoFlowGen = mod.cwrap(
                    'wasm_no_flow_gen',
                    'string',
                    ['string']
                );

                const wasmVisualizeJavaCode = mod.cwrap(
                    'wasm_visualize_java_code',
                    'string',
                    ['string']
                );


                //VizJS live update

                function debounce(fn, delay){
                    var timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => fn(...args), delay);
                    };
                }

                async function update(){https://dariandean0.github.io/Java-OO-Visualization/frontend/
                    var dotCode = wasmVisualizeJavaCode(getEditorContent())
                
                    Viz.instance().then(viz => {
                        const svg = viz.renderSVGElement(dotCode);
                        document.getElementById('Graph').innerHTML = "<div class='p-2 fw-bold' style='background-color: #DDDDDD;'>Memory Diagram</div>";
                        document.getElementById('Graph').appendChild(svg);
                    });
                }

                const debouncedUpdate = debounce(update, 500);

                EDITOR.on("change", debouncedUpdate);

                //const generateButton = document.getElementById("generate")
                //generateButton.addEventListener("click", async () => {
                //    var dotCode = wasmVisualizeJavaCode(getEditorContent())
                //    console.log(dotCode);
                //
                //    Viz.instance().then(viz => {
                //    const svg = viz.renderSVGElement(dotCode);
                //    document.getElementById('Graph').innerHTML = "<div class='p-2 fw-bold' style='background-color: #DDDDDD;'>Memory Diagram</div>";
                //    document.getElementById('Graph').appendChild(svg);
                //});
                //})
            })();
        </script>

        <div id="Visualizer" class="page pactive">
            <!-- Code Editor & Diagram -->
            <div class="container-fluid">
                <div class="row" style="height:94vh;">
                    <!--Code editor-->
                    <div class="col-6 d-flex flex-column" style="background-color: #FFFFFF; margin:0; padding:0;">
                        <div class="p-2 fw-bold" style="background-color: #DDDDDD;">Java Code Editor</div>
                            <textarea id="codeArea">public static void main(String[] args) {}</textarea>
                    
                            <!--Add codemirror-->
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/clike/clike.min.js"></script>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
                            <script>
                                const CODE_AREA = document.getElementById('codeArea')
                                const EDITOR = CodeMirror.fromTextArea(CODE_AREA, {
                                    mode: "text/x-java",
                                    theme: "default",
                                    lineNumbers: true,
                                    indentUnit: 4,
                                    tabSize: 4,
                                    lineWrapping: true,
                                    matchBrackets: true,
                                    autoCloseBrackets: true,
                                });

                                function getEditorContent() {
                                    return EDITOR.getValue();
                                }
                            </script>
                        </div>
                    <!--Diagram-->
                    <div id="Graph" class="col-6 d-flex flex-column" style="background-color: #FAFAFA; margin:0; padding:0;">
                        <div class="p-2 fw-bold" style="background-color: #DDDDDD;">Memory Diagram</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="Creator" class="page">

        </div>
        <div id="Comparer" class="page">

        </div>
        <!--Bootstrap-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    </body>
</html>